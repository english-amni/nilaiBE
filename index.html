<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nilai MK Inggris Bisnis - UNIMAR AMNI</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Favicon -->
    <link rel="icon" href="https://assets.nsd.co.id/images/kampus/logo/AMNI.png" type="image/png">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Apply Inter font and background */
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://www.shutterstock.com/image-vector/abstract-black-white-stripe-line-600nw-2478425579.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        #login-btn:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4 bg-black bg-opacity-60">

        <!-- Login Screen -->
        <div id="login-screen" class="w-full max-w-md">
            <div class="bg-gray-800 bg-opacity-80 backdrop-blur-sm shadow-2xl rounded-2xl p-8 space-y-6">
                <div class="text-center">
                    <img src="https://assets.nsd.co.id/images/kampus/logo/AMNI.png" alt="Logo UNIMAR AMNI" class="w-24 h-24 mx-auto mb-4">
                    <h1 class="text-2xl font-bold text-blue-400">Portal Nilai Mahasiswa</h1>
                    <p class="text-gray-400">Lecturer: Dhanan Abimanto</p>
                </div>
                <div id="login-error" class="hidden bg-red-500 text-white p-3 rounded-lg text-center"></div>
                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-300">Username (NIM)</label>
                        <input type="text" id="username" name="username" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan NIM Anda">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-300">Password</label>
                        <input type="password" id="password" name="password" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan password dengan NIM Anda">
                    </div>
                </div>
                <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Login
                </button>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="student-dashboard" class="hidden w-full max-w-4xl">
            <div class="bg-gray-800 bg-opacity-80 backdrop-blur-sm shadow-2xl rounded-2xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 id="welcome-message" class="text-3xl font-bold text-blue-400"></h2>
                        <p class="text-gray-400">Berikut adalah rincian nilai Anda.</p>
                    </div>
                    <button id="logout-btn-student" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-gray-700 rounded-lg">
                        <thead>
                            <tr class="bg-gray-900">
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Komponen Nilai</th>
                                <th class="py-3 px-6 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Nilai</th>
                            </tr>
                        </thead>
                        <tbody id="student-grades-body">
                            <!-- Data nilai mahasiswa akan dimasukkan di sini -->
                        </tbody>
                        <tfoot class="bg-gray-900 font-bold">
                            <tr>
                                <td class="py-3 px-6 text-left text-sm text-gray-200 uppercase">Rata-rata Nilai</td>
                                <td id="student-average" class="py-3 px-6 text-center text-lg text-yellow-300"></td>
                            </tr>
                            <tr>
                                <td class="py-3 px-6 text-left text-sm text-gray-200 uppercase">Nilai Huruf</td>
                                <td id="student-letter-grade" class="py-3 px-6 text-center text-lg text-yellow-300"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="hidden w-full max-w-7xl">
            <div class="bg-gray-800 bg-opacity-80 backdrop-blur-sm shadow-2xl rounded-2xl p-8">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-blue-400">Dashboard Admin</h2>
                        <p class="text-gray-400">Kelola data nilai mahasiswa.</p>
                    </div>
                    <div>
                         <button id="seed-btn" class="mr-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Seed Database</button>
                         <button id="logout-btn-admin" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</button>
                    </div>
                </div>
                <div id="admin-notification" class="hidden p-3 rounded-lg mb-4 text-center"></div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-gray-700 rounded-lg">
                        <thead class="bg-gray-900">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">NIM</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Nama</th>
                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Tugas</th>
                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">MID</th>
                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">UAS</th>
                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="admin-students-body">
                            <!-- Data semua mahasiswa akan dimasukkan di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modal for Delete Confirmation -->
        <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-lg font-bold text-white mb-4">Konfirmasi Hapus</h3>
                <p id="delete-modal-text" class="text-gray-300 mb-6"></p>
                <div class="flex justify-end space-x-4">
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white transition duration-300">Batal</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white font-semibold transition duration-300">Ya, Hapus</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBi8LvPc5B4cl0n3ivp6-OwmvVi5c9KD2I",
            authDomain: "nilai-bd05f.firebaseapp.com",
            databaseURL: "https://nilai-bd05f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nilai-bd05f",
            storageBucket: "nilai-bd05f.appspot.com",
            messagingSenderId: "497359554290",
            appId: "1:497359554290:web:4c9dd94fed37a1cc81726b",
            measurementId: "G-WLXJ7WP584"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const studentDashboard = document.getElementById('student-dashboard');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtnStudent = document.getElementById('logout-btn-student');
        const logoutBtnAdmin = document.getElementById('logout-btn-admin');
        const seedBtn = document.getElementById('seed-btn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const deleteModal = document.getElementById('delete-modal');
        const deleteModalText = document.getElementById('delete-modal-text');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        // --- State ---
        let nimToDelete = null;

        // --- Initial Data for Seeding ---
        const initialStudents = [
            { nim: '232704001', name: 'COBA-COBA' }, { nim: '242704001', name: 'ABDUL RAHMAN' }, 
            { nim: '242704002', name: 'AHMAD THAIB' }, { nim: '242704003', name: 'ANGGA SURYAFORTUNA' },
            { nim: '242704004', name: 'APRILIA NUR HAKIM' }, { nim: '242704005', name: 'CAESARIO NANDA BUANA' },
            { nim: '242704006', name: 'ELKANA DUHA' }, { nim: '242704007', name: 'ELKE FITRIA ELSHYNTA' },
            { nim: '242704008', name: 'ELMI ANDIKA NUROHMAN' }, { nim: '242704009', name: 'FAHRUL HUDA' },
            { nim: '242704010', name: 'HIMAWAN PRASETIO' }, { nim: '242704011', name: 'IMAM SYAIFURRACHMAN' },
            { nim: '242704012', name: 'M GUSLIM RAMADHAN BIMO BAWONO' }, { nim: '242704013', name: 'MARIANY MARSELINA GOIS' },
            { nim: '242704014', name: 'MUHAMMAD FAJAR' }, { nim: '242704015', name: 'MUHAMMAD IRIANSYAH' },
            { nim: '242704016', name: 'OKTAVIA BUDIAWATI' }, { nim: '242704017', name: 'PASKALIS LABA LUON' },
            { nim: '242704018', name: 'RAHMAN NUR HANUBUN' }, { nim: '242704019', name: 'RAYZHA RIFKI AULIATSANIE' },
            { nim: '242704020', name: 'RR. OKTALINDA NILASARI' }, { nim: '242704021', name: 'SYAFRIZAL' },
            { nim: '242704022', name: 'TRI YOGA PURNOMO' }, { nim: '242704023', name: 'VICTORIA PUTRI BAHARI SILABAN' },
            { nim: '242704024', name: 'ADOLFUS ANDIKA ADO BALA' }, { nim: '242704025', name: 'ARDHI ATSNI NORMAWAN' },
            { nim: '242704026', name: 'AVIOR DWIHAPSARI' }, { nim: '242704027', name: 'AZARIAS DARWIANTO DJITA' },
            { nim: '242704028', name: 'DEDE TRIPANI' }, { nim: '242704029', name: 'EVAN FRIDAYANTI NDURURU' },
            { nim: '242704030', name: 'FELLISIA YANUAR PRIMADHANI' }, { nim: '242704031', name: 'FRANSISKUS REWEMASE' },
            { nim: '242704032', name: 'GILANG SAHRIAL' }, { nim: '242704033', name: 'MIFTAHUL ARIFIN' },
            { nim: '242704034', name: 'MOCHAMAD CODROI' }, { nim: '242704035', name: 'RANIKA YANTI' },
            { nim: '242704036', name: 'SATRIO ANDRI CAHYO ASMORO' }, { nim: '242704037', name: 'HENDRI ADE WIBOWO' },
            { nim: '242704038', name: 'KUKUH OKTANUGRAH TRY WIYONO' }, { nim: '242704039', name: 'MUHAMMAD SYARIF RIZKI NAZAR' },
            { nim: '242704040', name: 'ZAHROTUL UYUNI' }, { nim: '242704041', name: 'ARMANSYAH WIDIANTO' },
            { nim: '242704042', name: 'DIMAS NANDA FAJAR FITRIANTO' }, { nim: '242704043', name: 'ERFIRA DINDA PUTRI' },
            { nim: '242704044', name: 'WULAN AGUSTA DINI RAHAYU' }, { nim: '242704045', name: 'KHOIRUNNISA' },
            { nim: '242704046', name: 'MUHAMMAD FIRSAN INDRA PRADIPTA' }, { nim: '242704047', name: 'RIZKY PRANANDA SARI' },
            { nim: '242704048', name: 'IWAN WEDA' }, { nim: '242704049', name: 'PITOYO' },
            { nim: '242704050', name: 'FIKRI AL AKBAR' }, { nim: '242704051', name: 'EGA CAHYANI PUTRI' },
            { nim: '242704052', name: 'SALSABILA AUDRI' }, { nim: '242704053', name: 'SYAFIYAH YULIANA' },
            { nim: '242704054', name: 'AGUS SUSANTO' }
        ];

        // --- Functions ---
        
        function showNotification(elementId, message, isError = false) {
            const notificationElement = document.getElementById(elementId);
            notificationElement.textContent = message;
            notificationElement.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            notificationElement.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => {
                notificationElement.classList.add('hidden');
            }, 3000);
        }

        async function seedDatabase() {
            try {
                for (const student of initialStudents) {
                    const studentRef = ref(db, 'public/students/' + student.nim);
                    await set(studentRef, {
                        name: student.name,
                        nim: student.nim,
                        nilai_tugas: 0,
                        nilai_mid: 0,
                        nilai_uas: 0
                    });
                }
                showNotification('admin-notification', 'Database berhasil diisi dengan data awal.', false);
            } catch (error) {
                console.error("Error seeding database: ", error);
                showNotification('admin-notification', `Gagal mengisi database: ${error.message}`, true);
            }
        }

        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            loginError.classList.add('hidden');

            if (username === 'admin' && password === 'admin123') {
                loginScreen.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                loadAdminData();
                return;
            }

            if (!username || !password) {
                loginError.textContent = 'Username dan Password tidak boleh kosong.';
                loginError.classList.remove('hidden');
                return;
            }

            const studentRef = ref(db, 'public/students/' + username);
            get(studentRef).then((snapshot) => {
                if (snapshot.exists() && password === username) {
                    const studentData = snapshot.val();
                    loginScreen.classList.add('hidden');
                    studentDashboard.classList.remove('hidden');
                    displayStudentData(studentData);
                } else {
                    loginError.textContent = 'NIM atau Password salah.';
                    loginError.classList.remove('hidden');
                }
            }).catch((error) => {
                console.error("Login error:", error);
                loginError.textContent = `Terjadi kesalahan: ${error.message}`;
                loginError.classList.remove('hidden');
            });
        }
        
        function handleLogout() {
            usernameInput.value = '';
            passwordInput.value = '';
            studentDashboard.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        /**
         * Converts a numerical score to a letter grade.
         * @param {number} score The average score.
         * @returns {string} The corresponding letter grade.
         */
        function getGradeLetter(score) {
            if (score >= 81) return 'A';
            if (score >= 70) return 'B';
            if (score >= 60) return 'C';
            if (score >= 50) return 'D';
            return 'E';
        }

        function displayStudentData(data) {
            const welcomeMessage = document.getElementById('welcome-message');
            const gradesBody = document.getElementById('student-grades-body');
            const studentAverageEl = document.getElementById('student-average');
            const studentLetterGradeEl = document.getElementById('student-letter-grade');

            const tugas = data.nilai_tugas || 0;
            const mid = data.nilai_mid || 0;
            const uas = data.nilai_uas || 0;
            
            // Calculate average and letter grade
            const average = (tugas + mid + uas) / 3;
            const letterGrade = getGradeLetter(average);

            welcomeMessage.textContent = `Halo, ${data.name}`;
            
            // Populate the main grades
            gradesBody.innerHTML = `
                <tr class="border-b border-gray-600">
                    <td class="py-4 px-6 font-medium text-gray-100">Nilai Tugas (Akumulasi)</td>
                    <td class="py-4 px-6 text-center text-lg font-semibold text-blue-300">${tugas}</td>
                </tr>
                <tr class="border-b border-gray-600">
                    <td class="py-4 px-6 font-medium text-gray-100">Nilai MID</td>
                    <td class="py-4 px-6 text-center text-lg font-semibold text-blue-300">${mid}</td>
                </tr>
                <tr>
                    <td class="py-4 px-6 font-medium text-gray-100">Nilai UAS</td>
                    <td class="py-4 px-6 text-center text-lg font-semibold text-blue-300">${uas}</td>
                </tr>
            `;

            // Populate the summary footer
            studentAverageEl.textContent = average.toFixed(2);
            studentLetterGradeEl.textContent = letterGrade;
        }
        
        function loadAdminData() {
            const studentsRef = ref(db, 'public/students/');
            onValue(studentsRef, (snapshot) => {
                const data = snapshot.val();
                const studentsBody = document.getElementById('admin-students-body');
                studentsBody.innerHTML = '';
                if (data) {
                    const sortedNims = Object.keys(data).sort();
                    sortedNims.forEach(nim => {
                        const student = data[nim];
                        const row = `
                            <tr class="border-b border-gray-600 hover:bg-gray-600 transition-colors">
                                <td class="py-3 px-4 text-gray-300">${student.nim}</td>
                                <td class="py-3 px-4 text-white font-medium">${student.name}</td>
                                <td class="py-3 px-4"><input type="number" step="any" id="tugas-${nim}" value="${student.nilai_tugas || 0}" class="w-20 bg-gray-900 text-center rounded p-1"></td>
                                <td class="py-3 px-4"><input type="number" step="any" id="mid-${nim}" value="${student.nilai_mid || 0}" class="w-20 bg-gray-900 text-center rounded p-1"></td>
                                <td class="py-3 px-4"><input type="number" step="any" id="uas-${nim}" value="${student.nilai_uas || 0}" class="w-20 bg-gray-900 text-center rounded p-1"></td>
                                <td class="py-3 px-4 text-center space-x-2">
                                    <button data-nim="${nim}" class="save-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Simpan</button>
                                    <button data-nim="${nim}" data-name="${student.name}" class="delete-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Hapus</button>
                                </td>
                            </tr>
                        `;
                        studentsBody.innerHTML += row;
                    });
                } else {
                    studentsBody.innerHTML = `<tr><td colspan="6" class="text-center py-4">Belum ada data mahasiswa. Klik 'Seed Database' untuk memulai.</td></tr>`;
                }
            }, (error) => {
                console.error("Error loading admin data:", error);
                showNotification('admin-notification', `Gagal memuat data: ${error.message}`, true);
            });
        }

        function handleSave(nim) {
            const tugas = document.getElementById(`tugas-${nim}`).value;
            const mid = document.getElementById(`mid-${nim}`).value;
            const uas = document.getElementById(`uas-${nim}`).value;
            
            const studentRef = ref(db, 'public/students/' + nim);
            get(studentRef).then(snapshot => {
                if (snapshot.exists()) {
                    const studentData = snapshot.val();
                    set(studentRef, {
                        ...studentData,
                        nilai_tugas: parseFloat(tugas),
                        nilai_mid: parseFloat(mid),
                        nilai_uas: parseFloat(uas)
                    }).then(() => {
                        showNotification('admin-notification', `Nilai ${studentData.name} berhasil diperbarui.`, false);
                    }).catch(error => {
                        showNotification('admin-notification', `Gagal menyimpan data: ${error.message}`, true);
                        console.error(error);
                    });
                }
            });
        }

        function handleDelete(nim, name) {
            nimToDelete = nim;
            deleteModalText.textContent = `Yakin ingin menghapus data "${name}" (NIM: ${nim})? Tindakan ini tidak dapat diurungkan.`;
            deleteModal.classList.remove('hidden');
        }

        function performDelete() {
            if (nimToDelete) {
                const studentRef = ref(db, 'public/students/' + nimToDelete);
                remove(studentRef).then(() => {
                     showNotification('admin-notification', `Data mahasiswa NIM ${nimToDelete} berhasil dihapus.`, false);
                }).catch(error => {
                    showNotification('admin-notification', `Gagal menghapus data: ${error.message}`, true);
                    console.error(error);
                });
            }
            closeDeleteModal();
        }

        function closeDeleteModal() {
            nimToDelete = null;
            deleteModal.classList.add('hidden');
        }

        // --- Authentication and Initialization ---
        // Disable login button until Firebase auth is ready
        loginBtn.disabled = true;
        loginBtn.textContent = 'Menghubungkan...';

        signInAnonymously(auth)
            .then(() => {
                console.log("Signed in anonymously. Ready to access database.");
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
                
                // Add event listeners after successful authentication
                loginBtn.addEventListener('click', handleLogin);
                passwordInput.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') handleLogin();
                });

                logoutBtnStudent.addEventListener('click', handleLogout);
                logoutBtnAdmin.addEventListener('click', handleLogout);
                seedBtn.addEventListener('click', seedDatabase);

                document.getElementById('admin-students-body').addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.classList.contains('save-btn')) {
                        handleSave(target.dataset.nim);
                    }
                    if (target.classList.contains('delete-btn')) {
                        handleDelete(target.dataset.nim, target.dataset.name);
                    }
                });
                
                cancelDeleteBtn.addEventListener('click', closeDeleteModal);
                confirmDeleteBtn.addEventListener('click', performDelete);
            })
            .catch((error) => {
                console.error("Anonymous sign-in failed:", error);
                loginError.textContent = `Gagal terhubung ke server otentikasi. Pastikan metode Anonymous diaktifkan di Firebase Console. Error: ${error.code}`;
                loginError.classList.remove('hidden');
                loginBtn.textContent = 'Gagal Terhubung';
            });

    </script>
</body>
</html>
